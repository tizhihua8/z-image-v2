# ============================================
# Z-Image v3 Docker Build & Push Workflow
# ============================================
# 触发条件:
#   - Push 到 main 分支
#   - 创建/推送 tag (v*)
# 功能:
#   - 自动构建单容器 Docker 镜像 (前端+后端+Nginx)
#   - 推送到 Docker Hub
#   - 支持多架构 (linux/amd64, linux/arm64)

name: Build and Push Docker Image

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:  # 允许手动触发

jobs:
  # ============================================
  # 构建单容器镜像 (All-in-One)
  # ============================================
  build-single:
    name: Build All-in-One Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/z-image
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: Build and Push Single Container Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.single
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=http://localhost:8000
          # 增加构建超时时间
          timeout: 3600
