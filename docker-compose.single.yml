# ============================================
# Z-Image v3 单容器部署配置
# ============================================
# 前端 + 后端 + Nginx 全部在一个容器中

version: '3.8'

services:
  # 单容器包含全部服务
  zimage:
    build:
      context: .
      dockerfile: Dockerfile.single
    container_name: zimage-all-in-one
    restart: unless-stopped
    ports:
      - "${APP_PORT:-80}:80"
    environment:
      # 基础配置
      - DEBUG=${DEBUG:-false}
      - SECRET_KEY=${SECRET_KEY}
      # 数据库
      - DATABASE_URL=sqlite+aiosqlite:///./app/data/zimage.db
      # OAuth
      - LINUX_DO_CLIENT_ID=${LINUX_DO_CLIENT_ID}
      - LINUX_DO_CLIENT_SECRET=${LINUX_DO_CLIENT_SECRET}
      - LINUX_DO_REDIRECT_URI=${LINUX_DO_REDIRECT_URI:-https://${DOMAIN}/api/auth/callback}
      # 前端地址
      - FRONTEND_URL=${FRONTEND_URL:-https://${DOMAIN}}
      # 管理员
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      # Worker
      - WORKER_API_KEY=${WORKER_API_KEY}
      # 存储
      - STORAGE_ROOT=/app/storage
      # 队列配置
      - MAX_QUEUE_LENGTH=${QUEUE_SOFT_LIMIT:-50}
      - HARD_QUEUE_LIMIT=${QUEUE_HARD_LIMIT:-500}
      - JOB_TIMEOUT_SECONDS=${JOB_TIMEOUT:-300}
    volumes:
      # 数据持久化
      - zimage-db:/app/data
      - zimage-storage:/app/storage
    networks:
      - zimage-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ============================================
# 网络配置
# ============================================
networks:
  zimage-network:
    driver: bridge
    name: zimage-network

# ============================================
# 数据卷
# ============================================
volumes:
  zimage-db:
    driver: local
    name: zimage-db
  zimage-storage:
    driver: local
    name: zimage-storage
